【評価対象データ】
・対象期間: 直近3年分
・使用特徴量:
  - 馬齢（BAREI）
  - 性別コード（SEIBETSU_CODE）
  - 馬体重（BATAIJU）
  - 負担重量（FUTAN_JURYO）
  - 単勝人気順（TANSHO_NINKIJUN）
  - 距離（KYORI）
  - 芝/ダート（トラックコード）（TRACK_CODE）
  - 頭数（SHUSSO_TOSU）
  - 騎手3着以内率（KISHU_3IN_RATE）
  - 馬場状態（TENKO_CODE）
  - 調教師3着以内率（CHOKYOSHI_3IN_RATE）
  - 父系統ID（FATHER_LINEAGE）
  - 馬過去5走3着以内率（UMA_5R_3IN_RATE）
  - コース適性3着以内率（COURSE_3IN_RATE）
  - コース×馬過去5走3着以内率（COURSE_UMA_5R_3IN_RATE）
  - 父系統ターゲットエンコーディング（FATHER_LINEAGE_TE）
  - トラックコードターゲットエンコーディング（TRACK_CODE_TE）
  - 馬体重×距離（BATAIJU_KYORI）
  - 馬齢×負担重量（BAREI_FUTAN_JURYO）
  - 騎手×調教師ターゲットエンコーディング（KISHU_CHOKYOSHI_TE）
  - 馬×コースターゲットエンコーディング（UMA_COURSE_TE）
  - レース間隔（日数）（RACE_KANKAKU）
  - 馬場状態（良=1, それ以外=0）（TENKO_FINE）

--- 評価結果 ---
Accuracy: 0.9793
F1 Score: 0.9538
              precision    recall  f1-score   support

           0       0.99      0.98      0.99      6165
           1       0.93      0.98      0.95      1715

    accuracy                           0.98      7880
   macro avg       0.96      0.98      0.97      7880
weighted avg       0.98      0.98      0.98      7880

--- PRカーブからF1最大化となる最適閾値: 0.511 ---
--- 最適閾値での再評価 ---
Accuracy: 0.9820
F1 Score: 0.9594
              precision    recall  f1-score   support

           0       0.99      0.98      0.99      6165
           1       0.94      0.98      0.96      1715

    accuracy                           0.98      7880
   macro avg       0.97      0.98      0.97      7880
weighted avg       0.98      0.98      0.98      7880


--- GPT-4.1からの改善アドバイス ---
モデル評価結果と4つのグラフ（ROCカーブ・PRカーブ・学習曲線・混同行列）を踏まえて、競馬の3着以内予測DQNモデルについて、改善のための簡潔なアドバイスをまとめます。

---

### 1. 現状のモデル性能
- **精度・F1スコアともに非常に高い（accuracy 0.98, F1 0.96）**
  - 不均衡データ（3着以内: 1,715 / 7,880 ≒ 21.8%）でも高リコール・高精度を維持
- **ROC曲線・PR曲線とも優秀**
  - ROC曲線はAUCがほぼ1.0に近い滑らかな形状
  - PR曲線も高く維持されており、PRバランスがよい
- **学習曲線も過学習の兆候はなく、train/testとも高いスコアで収束**
- **混同行列もFP/FNともに少ない**

---

### 2. 改善ポイント
#### (A) **特徴量の拡張・工夫**
- 既に多様な特徴量を利用しているが、**レース展開・ペース・枠順**などの追加も考慮
- **時系列要素（馬の調子変動, レース間のパフォーマンス推移）**があれば導入
- **馬ごとの固有ID・血統（母方）**もターゲットエンコーディング等で追加を検討

#### (B) **データ不均衡への対応**
- 現状は十分なリコールが出ているが、**更なる不均衡補正（SMOTEやクラス重み、アンダー/オーバーサンプリング）**も検討余地あり
- **閾値最適化（PRカーブで実施済）**は引き続き都度最適化する

#### (C) **モデル構造・アンサンブル**
- DQNは優秀だが、**他の手法（LightGBM, XGBoost, TabNet等）とのアンサンブル**による微改善も期待
- **モデルの深さ・ネットワーク構成のチューニング**で微調整

#### (D) **説明性・特徴量重要度の可視化**
- 競馬の場合、**なぜその予測をしたのかの説明性（SHAP, LIME等）**は重要
- 特徴量重要度を可視化し、不要な特徴量や過学習傾向のある特徴量を精査

#### (E) **外れ値・ノイズデータの検出と除去**
- **明らかな外れ値（極端な馬体重や負担重量等）**がないか再チェック
- **入力データのエラー・欠損値処理**の見直し

---

### 3. 運用上の注意
- **モデルの継続的な再学習**
  - 競馬は「流行」や「馬場傾向」の変化が激しいため、定期的な再学習が必要
- **リアルタイム・直前情報の活用**
  - 馬体重の直前変動や当日天候などをリアルタイムで反映できる体制を構築

---

### 4. まとめ
- **現状、実務レベルで十分通用する精度**
- 今後は「説明性」「データ拡張」「アンサンブル」「新規特徴量」「外れ値検出」などで更なる精度向上・運用性向上を目指すのが良い
- **過学習の兆候は見られないが、今後新データ増加時には再確認を徹底**

---

### おすすめ優先順位
1. **SHAPなどで特徴量重要度を可視化し、次の改善のヒントを探る**
2. **説明性向上（なぜ当たった/外れたか）を強化し、現場納得度を高める**
3. **新しい特徴量の追加トライアル（レース展開・馬の
