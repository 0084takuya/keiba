【評価対象データ】
・対象期間: 直近3年分
・使用特徴量:
  - 馬齢（BAREI）
  - 性別コード（SEIBETSU_CODE）
  - 馬体重（BATAIJU）
  - 負担重量（FUTAN_JURYO）
  - 単勝人気順（TANSHO_NINKIJUN）
  - 距離（KYORI）
  - 芝/ダート（トラックコード）（TRACK_CODE）
  - 頭数（SHUSSO_TOSU）
  - 騎手3着以内率（KISHU_3IN_RATE）
  - 馬場状態（TENKO_CODE）
  - 調教師3着以内率（CHOKYOSHI_3IN_RATE）
  - 父系統ID（FATHER_LINEAGE）
  - 馬過去5走3着以内率（UMA_5R_3IN_RATE）
  - コース適性3着以内率（COURSE_3IN_RATE）
  - コース×馬過去5走3着以内率（COURSE_UMA_5R_3IN_RATE）
  - 父系統ターゲットエンコーディング（FATHER_LINEAGE_TE）
  - トラックコードターゲットエンコーディング（TRACK_CODE_TE）
  - 馬体重×距離（BATAIJU_KYORI）
  - 馬齢×負担重量（BAREI_FUTAN_JURYO）
  - 騎手×調教師ターゲットエンコーディング（KISHU_CHOKYOSHI_TE）
  - 馬×コースターゲットエンコーディング（UMA_COURSE_TE）
  - レース間隔（日数）（RACE_KANKAKU）
  - 馬場状態（良=1, それ以外=0）（TENKO_FINE）

--- 評価結果 ---
Accuracy: 0.8330
F1 Score: 0.3985
              precision    recall  f1-score   support

           0       0.83      0.99      0.90      6165
           1       0.92      0.25      0.40      1715

    accuracy                           0.83      7880
   macro avg       0.87      0.62      0.65      7880
weighted avg       0.85      0.83      0.79      7880

--- PRカーブからF1最大化となる最適閾値: 0.036 ---
--- 最適閾値での再評価 ---
Accuracy: 0.7183
F1 Score: 0.5969
              precision    recall  f1-score   support

           0       0.98      0.65      0.78      6165
           1       0.43      0.96      0.60      1715

    accuracy                           0.72      7880
   macro avg       0.71      0.81      0.69      7880
weighted avg       0.86      0.72      0.74      7880


--- GPT-4.1からの改善アドバイス ---
モデル評価結果と4つのグラフから、以下のポイントでモデル改善を検討すると良いです。

---

### 1. クラス不均衡への対応

- **課題**: 3着以内（＝1）のデータが少なく、精度（accuracy）が高くても、再現率・F1スコアが低くなっています（特に閾値デフォルト時）。
- **改善策**
  - **損失関数の重み付け**や**サンプルのオーバーサンプリング（SMOTEなど）**を検討してください。
  - **アンダーサンプリング**も有効ですが、データ量が多い場合のみ。
  - **Focal Loss**導入も有効です。

---

### 2. 閾値調整の活用

- **課題**: PRカーブ・詳細指標から、デフォルト閾値（0.5）では再現率が低い。最適閾値（0.036）では再現率は大幅に改善しF1も上昇。
  - ただし、precisionが大きく低下し、False Positiveが増えます。
- **改善策**
  - **用途（予想利用シナリオ）に応じて、最適な閾値を柔軟に調整・運用**しましょう。
  - 例えば、的中率よりも「穴馬発見」重視なら低め閾値で広く候補を拾うなど。

---

### 3. 特徴量の見直し・追加

- **課題**: ROC曲線からAUCはやや高いが、PR曲線の形状から1クラス極端バランスでF1が伸びにくい。
- **改善策**
  - **特徴量重要度を調査し、寄与の低い特徴量の除去や新規特徴量の追加**を検討。
  - **馬ごと・騎手ごとの直近パフォーマンスやコンディション**、**当日の馬場情報**など、今後変動しやすい情報も加味すると精度向上の余地あり。
  - 特に**「Target Encoding」特徴量**が多いので、リークや過学習に注意し、分割手法やエンコーディング設計を再確認しましょう。

---

### 4. モデル構造・手法の検討

- **課題**: DQN（強化学習型）を用いているが、純粋な分類問題（3着内判定）としては、**勾配ブースティング系（LightGBM/XGBoost等）やNN分類**のほうが構造的に適する場合も。
- **改善策**
  - **異なる分類モデルと比較（アンサンブル含む）**し、最適な手法を検証する。
  - DQNの出力を「期待値ランキング」等に活用し、直接的なラベル予測は他モデルで補完する案も考えられます。

---

### 5. 学習曲線・過学習への注意

- **課題**: learning_curve.pngから、学習・検証誤差がある程度収束していますが、まだgapがある場合はデータ量増強や正則化も検討。
- **改善策**
  - **データ拡張やクロスバリデーションの徹底**。
  - **DropoutやEarly Stopping**などの正則化も有効です。

---

### まとめ

- **クラス不均衡対策を強化**
- **モデル閾値を用途に応じて柔軟に調整**
- **特徴量の見直し・追加。ターゲットエンコーディングの設計にも注意**
- **異なる分類手法も比較し、アンサンブルも検討**
- **学習曲線を見て過学習・データ量もチェック**

これらを順に取り入れることで、3着以内予測の実用精度・安定性がさらに向上するはずです。
