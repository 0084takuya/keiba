--- 評価結果 ---
Accuracy: 0.9060
F1 Score: 0.8146
              precision    recall  f1-score   support

           0       1.00      0.88      0.94      8852
           1       0.69      1.00      0.81      2307

    accuracy                           0.91     11159
   macro avg       0.84      0.94      0.88     11159
weighted avg       0.94      0.91      0.91     11159

--- PRカーブからF1最大化となる最適閾値: 0.856 ---
--- 最適閾値での再評価 ---
Accuracy: 0.9636
F1 Score: 0.9126
              precision    recall  f1-score   support

           0       0.98      0.98      0.98      8852
           1       0.91      0.92      0.91      2307

    accuracy                           0.96     11159
   macro avg       0.94      0.95      0.94     11159
weighted avg       0.96      0.96      0.96     11159


--- GPT-4.1からの改善アドバイス ---
モデル評価結果・各種指標・グラフから見たDQNモデル改善アドバイス

1. **全体的な評価**
- 精度・F1スコアともに非常に高く、バランスの取れたモデル。
- 最適閾値調整による指標向上も見られ、実運用水準に近い。
- ROC/PRカーブもAUCが高く、識別性能は十分に高い。

2. **改善余地のある点（グラフ/指標/特徴量から）**
- 混同行列より、0（非3着以内）を1（3着以内）と誤判定するFalse Positiveが相対的にやや多い（特に閾値調整前）。
- 特徴量のうち、「父系統ID」や「コース×馬過去5走3着以内率」などカテゴリ変数が多く、エンコーディングや組み合わせの工夫余地あり。
- 学習曲線は過学習傾向が少なく、まだ学習余地あり。

3. **具体的な改善提案**

**A. 特徴量エンジニアリング**
- 「父系統ID」「TRACK_CODE」などカテゴリ変数には、  
　・ターゲットエンコーディング  
　・頻度ベースエンコーディング  
　・Embedding層導入（深層学習的手法）  
　が有効。  
- 「馬齢」「馬体重」「距離」「負担重量」などは、  
　・多項式特徴量作成（例：馬体重×距離、馬齢×負担重量等）  
　・標準化・正規化  
　を追加。
- 「騎手3着以内率」「調教師3着以内率」などは時系列での直近加重平均化、前走との変動幅特徴追加も有効。

**B. ネットワーク構造・学習手法の工夫**
- DQNのネットワーク層数やユニット数、活性化関数の最適化。
- DropoutやBatchNormalization導入による汎化性能向上。
- 損失関数を「Focal Loss」や「Class-balanced loss」に変更し、少数クラス（3着以内）への感度をより高める。

**C. データ拡張・サンプルバランシング**
- 3着以内サンプルが相対的に少ない場合は、SMOTE等による合成データ生成や重み付け学習を検討。
- 時系列データを利用し、同馬・同騎手・同調教師の直近レース特徴を複数窓で入力する。

**D. モデルアンサンブル**
- 異なるアルゴリズム（例：LightGBM, XGBoost, TabNet等）とのスタッキング・バギングも有効。
- レース条件（芝/ダート、距離カテゴリ別など）でサブモデルを作成し、最終判定をアンサンブル。

**E. モデル評価指標の詳細分析**
- ROC/PR曲線で閾値最適化が有効だったため、現場運用では「利益最大化」「的中率重視」など目的別閾値最適化を継続。
- レースごとの特徴（例：フルゲートかどうか、重馬場など）でサブグループごとに再評価し、偏りが無いか確認。

---

**まとめ**
現状のモデルは非常に高性能ですが、さらなる精度・再現率向上のためには「カテゴリ特徴量の高度処理」「時系列特徴追加」「損失関数最適化」「モデルアンサンブル」が有効です。  
また、誤判定パターンの詳細分析や、現場利用の目的（利益/的中率/回収率など）にあわせた閾値・評価指標の最適化も継続してください。
