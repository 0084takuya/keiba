
```bash
$ pip install -r requirements.txt

$ python train_rl.py \
     --host localhost \
     --user root \
     --password "" \
     --database mykeibadb \
     --entry_table umagoto_race_joho \
     --result_table record_master \
     --timesteps 200000 \
     --lookback_number 3 --lookback_unit MONTH

$ python plot_feature_importance.py \
  --model_path horse_racing_ppo \
  --host localhost --user root --password '' \
  --database mykeibadb --entry_table umagoto_race_joho \
  --result_table record_master --max_samples 1000

$ python plot_correlation.py \
  --host localhost --user root --password '' \
  --database mykeibadb --entry_table umagoto_race_joho \
  --result_table record_master --max_samples 5000 \
  --lookback_number 3 --lookback_unit MONTH
```


```bash
python keiba_sanshutsu/data_preprocessing/extract_features.py
python keiba_sanshutsu/data_preprocessing/clean_data.py
python keiba_sanshutsu/analysis/basic_stats.py
python keiba_sanshutsu/analysis/correlation.py
python keiba_sanshutsu/analysis/visualize.py

```

# 算出したいもの
3位以内に入る確率
上記が出せれば、馬の買い方を絞れる
最終的に出したいのは、どの組み合わせで買えば、当たりやすくかつ賭けた金額より多くリターンが得られるか
最大となる期待値を求める、関数やグラフなどで図式で示してわかりやすく頂点であることを示すこと
例えば、上に凸になる二次関数の形であれば、頂点となる座標点の買い方が最大利益になる
上位N頭に絞れば、残りは組み合わせを買えばいい

# 手順を分けるとすると
① ABワークフロー
A「3位以内に入る馬の特徴を学習するモデル」
- mykeibadbにあるデータを全て参照して参照すること　mykeibadb/db/mykeibadb-schema.sql
- 深層強化学習の手法を複数セット用意して学習モデルを複数個作って評価すること
- 前処理
  - 学習する項目をまずリストアップする。項目が存在するかわからないのでまず直近の1レースに着目して、スプシにまとめること
- 

B「学習した馬の変動確率を加味した、オッズの変動から見るベイズ」
- 前段、中段、後段に分けたベイズモデルである
- 前段は、初期状態。100%を頭数で等分した値が初期値で、どの馬も同じ確率となる
- 中段では、リストアップした着目する項目（keiba_sanshutsu/sanshutsu_items_with_notes.csv）における3位以内に入る確率変動をベイズで計算する。ここまでは当該レーズのオッズを加味しない
- 後段は、変動するオッズをレーズ直前まで参照する。レース直前になると期待値がより高まるため係数関数としてバスタブ曲線の値とオッズを掛け合わせた数字を評価して、ベイズをかける
- これらを通してできたベイズ変動の関数を評価して、上位Nの馬をリストアップする。


② ①のパターンをチューニングして、よりよい３つの異なる手法を考える
例えば、学習モデルは学習の種となる前処理の項目をより細かくする、消す、新しい観点を追加するなど。
異なる手法で言うと3人のおじさんが競馬をやるように、三者三様の考え方を拾うため。

③ その3つをもとに合議をとって最終の結論を出す
１つの買い方に決定したい。





# 競馬そのものの真実、わかっていること

## 🗓 季節・気候の傾向
- **夏は牝馬（ひんば）**
  - 暑さに強い牝馬が夏競馬（福島、新潟、小倉、函館、札幌）で好成績。
- **冬は大型馬・パワー型**
  - パワータイプや体格の大きな馬が冬季開催で好走しやすい。
- **梅雨時期は重馬場巧者**
  - 雨で馬場が重くなると、欧州血統やパワー系血統が有利。

---

## 🐴 馬場状態の傾向
- **高速馬場ではスピード血統**
  - サンデーサイレンス系（特にディープインパクト産駒）などスピード重視の血統が活躍。
- **時計のかかる馬場では欧州血統**
  - ハービンジャー産駒、キングマンボ系など、スタミナやパワーが求められる馬場に強い。
- **コースごとの枠順の有利不利**
  - 中山芝1200m（内枠有利）、東京芝1600m（外枠差し馬有利）など。

---

## 👥 年齢・性別に関する傾向
- **クラシック（3歳春）は早生まれ有利**
  - 1〜3月生まれの馬が成長面で有利。
- **高齢馬は距離短縮が効果的**
  - 高齢化するとスタミナ低下、距離短縮で再活躍の傾向。
- **斤量恩恵を受ける牝馬**
  - 実力が拮抗するレースでは、牡馬より斤量が軽い牝馬が有利。

---

## 🔄 ローテーションによる傾向
- **休み明け2戦目での好走傾向**
  - 休養明け初戦を叩いた2戦目が狙い目。
- **間隔が短すぎる馬は割引**
  - 中1週以内で出走を繰り返す馬は疲労蓄積のリスクあり。

---

## 🏇 コース特性別の傾向
- **東京競馬場は瞬発力重視**
  - 長い直線で瞬発力・末脚が活きるコース。
- **中山競馬場は器用さ・パワー重視**
  - 小回りや急坂を得意とする馬が活躍。
- **新潟・京都外回りは追い込み有利**
  - 直線が非常に長く、後方待機の馬が届きやすい。

---

## 🏅 騎手に関する傾向
- **リーディング上位騎手は人気馬で安定**
  - ルメール、川田将雅、武豊らは人気馬で高確率で馬券圏内。
- **地方開催は地元騎手が有利**
  - ローカル競馬では地元騎手がコース熟知で好成績。

---

## 📌 その他の経験則
- **格上挑戦馬は穴になりやすい**
  - クラスが上がって初戦は割引きがちだが、馬券的には妙味がある。
- **距離延長より距離短縮の方が好走率が高い**
  - スタミナ面で余裕ができ、好走しやすい。
- **逃げ馬は単騎逃げが理想**
  - 単独で先頭に立つとペースを握り、そのまま逃げ切ることが多い。

---

## 📅 時期・開催条件の傾向
- **函館・札幌の洋芝巧者**
  - 夏の北海道開催（函館・札幌）は洋芝適性が問われるため、パワー型の欧州血統が有利。
- **新馬戦は調教時計と厩舎信頼度**
  - 初出走馬（新馬戦）は調教の良し悪しと厩舎の勝負度合いが大きく影響する。
- **地方交流重賞は中央馬圧倒的優位**
  - 中央競馬所属の馬が地方交流重賞（川崎記念、帝王賞など）で圧倒的に好成績を収める傾向がある。

---

## 🧬 血統に関する傾向
- **ダート短距離は米国血統が強い**
  - サウスヴィグラス産駒、ヘニーヒューズ産駒などの米国系が圧倒的に有利。
- **長距離戦はステイヤー血統重視**
  - 芝3000m以上ではステイヤー血統（ハーツクライ系、ステイゴールド系）が好走しやすい。
- **初ダートは米国系種牡馬産駒が穴**
  - 芝から初めてダートに転向する場合、米国血統の馬は激走の可能性がある。

---

## 💪 馬の特徴に関する傾向
- **ブリンカー装着馬は集中力アップ**
  - ブリンカー（視界制限具）を初めてつけると集中力が増し、激走する馬が多い。
- **去勢明けの馬は精神面で改善**
  - 去勢手術（セン馬）後の初戦や2戦目でパフォーマンスが急激に向上するケースがある。
- **大型馬は叩き2～3戦目が狙い目**
  - 500kgを超える大型馬は休養明け2～3戦目で絞れてピークになることが多い。

---

## 🐎 レース展開・ペースによる傾向
- **スローペースは前残り傾向**
  - スローペースになると逃げ馬や先行馬が脚を残してそのままゴールしやすい。
- **ハイペースは差し・追込馬有利**
  - 前半ペースが速くなると先行馬が潰れ、後方待機馬が突っ込みやすい。
- **内回りコースは先行馬有利**
  - 中山や阪神内回りなど、直線の短いコースでは先行馬が有利。

---

## 🎯 厩舎や調教師に関する傾向
- **関西馬の関東遠征は勝負度高め**
  - 関西所属の有力馬が東京や中山に遠征する場合、勝負をかけているケースが多い。
- **騎手・調教師コンビは要注意**
  - 特定の騎手と調教師が組んだ場合、勝負度が高まり成績が良くなる傾向がある（例: 池江厩舎と武豊騎手、矢作厩舎と坂井騎手）。

---

## 🔖 馬券・人気傾向
- **1番人気の複勝率は約60〜70%**
  - 1番人気は約3回に2回は馬券圏内に入る。
- **ハンデ戦は波乱が多い**
  - 斤量差が生じるハンデ戦では穴馬が台頭しやすく、高配当が出やすい。
- **荒天時は波乱傾向**
  - 雨や風が強い荒天の日は、実力馬が力を発揮しにくく波乱が多い。

---

## 🔹 レース間隔による傾向
- **長期休養明け（半年以上）は割引**
  - 長期間休養した馬は能力を完全に発揮しにくいが、2戦目以降での変わり身が狙い目。
- **短期放牧明け（1～2ヶ月程度）は好走傾向**
  - リフレッシュ目的の短期放牧明けは調子を戻して好走する馬が多い。
- **叩き3走目以降は疲労蓄積に注意**
  - 叩き3戦目以降は疲労が溜まり、成績が下降傾向になる馬が多い。

---

## 🟢 体重変動に関する傾向
- **プラス体重は成長や回復を示唆**
  - 若い馬の＋10kg以内の馬体増は好走傾向。特に3歳馬に多い。
- **マイナス体重は調子のピーク**
  - 絞れて馬体が減った場合、特に大型馬では好走傾向。
- **急激な馬体減（-10kg以上）は割引き**
  - 大幅な馬体減は体調悪化を示す可能性があり、パフォーマンス低下の傾向。

---

## 📌 パドック・返し馬の傾向
- **パドックで発汗がひどい馬は割引**
  - 極端な発汗は緊張や体調不良を示す可能性が高い。
- **落ち着いている馬が狙い目**
  - 周囲を気にせずリラックスしている馬は本来の力を発揮しやすい。
- **返し馬（ウォーミングアップ）がスムーズな馬**
  - 返し馬で軽快に走る馬は調子が良いことが多い。

---

## 🚀 コース実績・得意条件の傾向
- **特定コースでリピーターが多いレース**
  - 特定の重賞（例：中山金杯、函館記念）は過去の好走馬が繰り返し好成績を残しやすい。
- **右回り・左回りの得手不得手**
  - 馬によって右回りや左回りに得意不得意がはっきりしていることがある（例：東京巧者、新潟巧者）。
- **坂の有無による適性**
  - 中山や阪神など坂がある競馬場では、坂適性のある馬が優位。

---

## 🌍 遠征・輸送による傾向
- **初遠征馬は割引**
  - 初めての長距離輸送で馬が疲労・ストレスを抱える場合が多い。
- **何度も遠征経験がある馬は安定**
  - 輸送経験が豊富な馬は遠征の影響が少なく、安定して走ることが多い。

---

## 💡 ジョッキーの傾向（追加）
- **乗り替わりは注意**
  - 前走と異なる騎手が騎乗すると、戦略変更でパフォーマンスが向上することがある（特にトップ騎手への乗り替わり）。
- **同じ騎手が継続騎乗は好材料**
  - 連続騎乗で馬の癖を把握している騎手は、成績が安定する傾向。

---

## 📉 人気薄馬に関する傾向
- **前走惨敗馬の巻き返し**
  - 前走で大敗したが、条件が大幅に変化した（距離・馬場・展開）場合は激走しやすい。
- **人気薄の逃げ馬は注意**
  - 人気のない逃げ馬が単騎で逃げるとそのまま波乱を起こすことが多い。

---

## 🗂 馬具や装備変更による傾向
- **シャドーロール装着は変わり身の可能性**
  - シャドーロール（地面を見る癖を矯正）を初めて装着すると激走することがある。
- **舌縛り（タンタイ）で呼吸改善**
  - 舌縛りを装着すると呼吸が改善され、前走から一変することが多い。

---


## 🗓 開催日程に関する傾向
- **開幕週は内枠・先行馬が有利**
  - 開催初週は芝の状態が良好なため、内枠から先行した馬が好成績。
- **最終週は外差し傾向**
  - 開催終盤は内が荒れ、外枠や後方待機の差し馬が届きやすくなる。

---

## 🌧 馬場悪化時の追加傾向
- **ダートの重・不良馬場は前残り**
  - ダートが湿るとスピードが出やすくなり、先行・逃げ馬が有利。
- **芝の重馬場は外枠・差し馬有利**
  - 芝が荒れると内枠の馬が苦しくなり、外枠から差す馬が伸びやすい。

---

## 🐎 距離・条件変更による傾向
- **短距離から距離延長する逃げ馬は苦戦**
  - 短距離戦で逃げていた馬が距離を延ばすと、スタミナ面で苦しくなる傾向。
- **ダートから芝への転向は割引**
  - ダート実績馬が芝初挑戦の場合、基本的に苦戦傾向。ただし血統次第で穴になるケースも。
- **芝からダートへの転向は血統次第**
  - 米国系血統の芝→ダート転向馬は激走しやすく、穴馬として注目されやすい。

---

## 📌 調教内容・調整パターンの傾向
- **坂路調教が速い馬は短距離向き**
  - 坂路で好時計を出す馬は短距離レースで好成績を挙げやすい。
- **長距離戦はウッドコース調教が重要**
  - 芝の長距離レースではウッドチップコースで長めに負荷をかけた馬が活躍しやすい。

---

## 🛡 騎手の特性・傾向（追加）
- **若手騎手は斤量差で穴を開ける**
  - 減量特典を持つ新人・若手騎手は斤量恩恵で穴馬を激走させやすい。
- **ベテラン騎手は展開読みが巧み**
  - 武豊、横山典弘らベテラン騎手は展開を読んで奇襲的な好走を演出しやすい。

---

## 🗒 重賞特有の傾向
- **牝馬限定戦はリピーターが多い**
  - エリザベス女王杯やヴィクトリアマイルは前年好走馬が再び好走しやすい。
- **GⅠ直前のトライアル戦は人気馬が堅実**
  - GⅠトライアル（弥生賞、神戸新聞杯など）は人気馬が順当に結果を残しやすい。

---

## 📊 オッズと人気に関する傾向（追加）
- **断然人気（単勝1倍台）は高信頼度**
  - 単勝1倍台の人気馬は信頼度が極めて高く、勝率は約50%以上。
- **人気薄の先行馬は要注意**
  - 人気のない先行馬は展開次第で穴を開けやすく、ヒモ穴として要注目。

---

## 🎲 ハンデ戦特有の追加傾向
- **ハンデ戦のトップハンデ馬は苦戦**
  - 58kg以上のトップハンデ馬は苦戦傾向だが、GⅠ級の実績馬なら信頼性は高い。
- **軽ハンデ（51kg以下）は激走注意**
  - ハンデ戦で斤量51kg以下の馬は軽量を活かして波乱を演出しやすい。

---

## ⚙️ 馬具・装備の追加傾向
- **初めてのチークピーシーズは変わり身のチャンス**
  - 集中力を高めるチークピーシーズを初装着した馬は激走するケースがある。
- **クロス鼻革（クロス鼻革）は要注意**
  - 集中力を高めるクロス鼻革を新たに装着すると馬が一変し、激走が見られることがある。

---

## 📝 その他の特殊傾向
- **マイルCSはスプリンターが穴を開けやすい**
  - マイルチャンピオンシップではスプリント実績馬がスピードを活かし、波乱の中心になるケースが多い。
- **宝塚記念はリピーターが多い**
  - 宝塚記念では前年好走馬が再び好成績を残しやすく、リピーター傾向が顕著。

---

## 📝 競馬におけるさらに細かな経験則・傾向（追加）

## 🐴 馬体・外見の傾向
- **芦毛馬は道悪（重馬場）に強い傾向**
  - 一般的に芦毛馬は雨天時の湿った馬場に強いことが多く、馬券的にも穴になりやすい。
- **小柄な馬（430kg以下）は短距離向き**
  - 小型馬はスタミナ面の限界から、特に芝短距離（1000m〜1200m）で活躍しやすい。

---

## 📍 コース特性別追加傾向
- **福島・小倉などローカルは逃げ馬が有利**
  - 小回り平坦コース（福島芝1200m、小倉芝1200m）は逃げ馬や先行馬がそのまま残りやすい。
- **阪神内回りは先行馬・内枠有利**
  - 阪神芝2000m（内回り）は直線が短いため、内枠から先行した馬が有利。

---

## 🔄 馬齢別の追加傾向
- **2歳戦は早熟血統が強い**
  - ダイワメジャー産駒など早熟タイプの血統は2歳戦で圧倒的に有利。
- **古馬（5歳以上）は芝→ダート転向で穴狙い**
  - 芝の成績が頭打ちになった古馬はダート転向で大きく変わることがある。

---

## 🧪 調教パターン別の追加傾向
- **1週前追い切りが好時計の馬は本番好走**
  - 直前より1週前に強い負荷をかけた馬が本番で好結果を残しやすい。
- **併せ馬調教で先着した馬は好調**
  - 調教で併せ馬を行い、先着した馬は実戦で好走率が高まる。

---

## 🔄 馬主や生産牧場の傾向
- **社台グループ生産馬は芝の重賞で強い**
  - 社台系牧場（ノーザンファーム、社台ファームなど）の生産馬は特に芝のGⅠで好成績。
- **地方競馬で外厩仕上げ馬は狙い目**
  - 南関東（大井・川崎など）の地方競馬で外厩仕上げ馬は高い好走率を示す。

---

## 🚚 輸送距離に関する傾向（追加）
- **東→西の輸送は割引き傾向**
  - 美浦（関東）所属馬が栗東（関西）や小倉まで輸送するとストレスで成績が落ちる傾向がある。
- **短距離輸送は好材料**
  - 関西馬の京都・阪神間、関東馬の中山・東京間など短距離輸送は疲労が少なく好走率が高い。

---

## 🥇 ジョッキーに関する細かな追加傾向
- **トップジョッキーは重賞・GⅠで集中騎乗**
  - ルメール騎手、川田騎手らは重賞・GⅠの日には好騎乗が集中しやすい。
- **逃げが得意な騎手は要注意**
  - 横山典弘騎手や吉田隼人騎手など、逃げ戦術が巧みな騎手が騎乗すると波乱の可能性が高まる。

---

## 💳 馬券の買い方・オッズ傾向
- **単勝が異常に売れる馬は信頼度高め**
  - 単勝の売れ行きが他の馬券種より突出している場合、馬券内率が高くなる。
- **オッズ急落馬は勝負度が高い**
  - 直前にオッズが急激に下がる馬は関係者の勝負度が高く、好走する傾向にある。

---

## 🔬 ハンデキャップレース特有の追加傾向
- **斤量増（前走比＋2kg以上）の馬は割引**
  - 前走より斤量が大きく増加した馬はパフォーマンスが落ちる傾向がある。
- **牝馬の軽量ハンデは激走の可能性大**
  - 牝馬がハンデ戦で軽量（51kg以下）を背負う場合、好走率が非常に高い。

---

## 📑 その他特定レースの傾向
- **ジャパンカップは外国馬が苦戦傾向**
  - 近年のジャパンカップでは外国馬は苦戦が続いており、日本馬が優位。
- **中山大障害はリピーターが多い**
  - 障害の名物レース「中山大障害」では過去の好走馬が繰り返し好走しやすい。

---
